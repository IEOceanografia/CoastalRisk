clear all;
close all;


nc=netcdf('/data/Roms_simula/SimulaRaia/op_conf/Raia_grd3_masked.nc.1');
lon=nc{'lon_rho'}(:);
lat=nc{'lat_rho'}(:);
mask=nc{'mask_rho'}(:);
isee=find(mask==0);
mask(isee)=nan;
h=nc{'h'}(:);
h=h.*mask;


 %dataorig=textread('positions_2012_1h_oil.txt');
 %dataorig=textread('positions_2012_oil_innerstep_deflect.txt');
 dataorig=textread('positions_2012_oil_innerstep_sindeflect.txt');
 
 %Elmino datos que se acercaron a los fronteras
 isee=find(dataorig(:,5)>-9.5 & dataorig(:,5)<-7.85 & dataorig(:,6)>40.8 & dataorig(:,6)<44);
 dataorig=dataorig(isee,:);
 time=gregorian(dataorig(:,4)./86400+julian(2009,1,1));
 mes=time(:,2);
 
 %Por como corri el modelo lagrangiano , junio tiene 26 días y diciembre 27...para poder seguir las partículas en los días siguientes
 diasdelmes=[31 29 31 30 31 26 31 31 30 31 30 27];
 num_orig_part=2345;

 mensual=0; %De lo contrario lo hará anual...

 if(mensual)
   loopinmonths=12;
   Nrepsinitial=diasdelmes.*24;
 else
   loopinmonths=1;
   Nrepsinitial=sum(diasdelmes)*24;
 end
 
 for repeticion=1:loopinmonths

     Nreps=Nrepsinitial(repeticion);
     
     for diapred=1:4

        if(mensual)
          isee=find(mes==repeticion);
          data=dataorig(isee,:);
        else
          data=dataorig;
        end
        
        if(diapred==1)
   		isee=find(data(:,7)>=1 & data(:,7)<24);
        elseif(diapred==2)
   		isee=find(data(:,7)>24 & data(:,7)<=48);
        elseif(diapred==3)
   		isee=find(data(:,7)>48 & data(:,7)<=72);
        elseif(diapred==4)
		isee=find(data(:,7)>72 & data(:,7)<=96);
        end
 	data=data(isee,:);


		 disp(['Porcentaje de llegada total en el anho:', num2str(length(data)/(num_orig_part*Nreps)*100)]);

		 isee12=find(data(:,1)==1 | data(:,1)==2);
		 disp(['Zona 1 y 2: ', num2str(length(isee12)/(365*Nreps)*100)]);
		 isee34=find(data(:,1)==3 | data(:,1)==4);
		 disp(['Zona 3 y 4: ', num2str(length(isee34)/(350*Nreps)*100)]);
		 isee56=find(data(:,1)==5 | data(:,1)==6);
		 disp(['Zona 5 y 6: ', num2str(length(isee56)/(325*Nreps)*100)]);
		 isee78=find(data(:,1)==7 | data(:,1)==8);
		 disp(['Zona 7 y 8: ', num2str(length(isee78)/(305*Nreps)*100)]);
		 isee9=find(data(:,1)==9);
		 disp(['Zona 9: ', num2str(length(isee9)/(500*Nreps)*100)]);
		 isee10=find(data(:,1)==10);
		 disp(['Zona 10: ', num2str(length(isee10)/(500*Nreps)*100)]);

		 load paletaazul.mat

		 fig=figure('position',[20 20 600 800]);
		 set(fig,'Color','w');
		 m_proj('Mercator','long',[-10.4 -7.74],'lat',[41 44.1]);
		 m_pcolor(lon,lat,h);
		 caxis([10 4000]);
		 colormap(paletaazul);
		 shading interp;
		 hold on;

		 m_usercoast('/home/montealto/Roms_Agrif/OPERATIONAL2/Europe.mat','color',[0.5 0.5 0.5]);
		 m_grid('box','off','color',[0.7 0.7 0.7],'fontsize',12)

		%Colores pastel
		if(0)
		 color1=[251 180 174]./256;
		 color2=[254 217 166]./256;
		 color3=[204 235 197]./256;
		 color4=[222 203 228]./256;
		 color5=[255 255 204]./256;
		 color6=[179 222 105]./256;
		end

		%Colores pop
		if(0)
		 color1=[27 158 119]./256;
		 color2=[217 95 2]./256;
		 color3=[117 112 179]./256;
		 color4=[231 41 138]./256;
		 color5=[102 166 30]./256;
		 color6=[230 171 2]./256;
		end

		%Colores intermedios
		if(1)
		 color1=[102 194 165]./256;
		 color2=[252 141 98]./256;
		 color3=[141 160 203]./256;
		 color4=[231 138 195]./256;
		 color5=[166 216 84]./256;
		 color6=[255 217 47]./256;
		end

		%Colores mix
		if(0)
		 color1=[251 180 174]./256;
		 color2=[254 217 166]./256;
		 color3=[204 235 197]./256;
		 color4=[222 203 228]./256;
		 color5=[117 112 179]./256;
		 color6=[179 222 105]./256;
		end

                %Polígonos del corredor
                v=[-10.2292 42.8777; -10.2292 43.31293; -10.08779 43.52240; -10.02875 43.49651; -10.1661 43.29429; -10.1661 42.8777];
                m_patch(v(:,1),v(:,2),color1,'FaceAlpha',0.5,'EdgeColor',color1,'LineWidth',2);
                v=[-10.13861 42.8777; -10.13861 43.28894; -10.00128 43.49153; -9.93261 43.46861; -10.07131 43.27395; -10.07131 42.8777];
                m_patch(v(:,1),v(:,2),color2,'FaceAlpha',0.5,'EdgeColor',color2,'LineWidth',2);
                v=[-9.98480 42.8777; -9.98480 43.24394; -9.85021 43.43471; -9.78155 43.41277; -9.91339 43.22593; -9.91339 42.8777];
                m_patch(v(:,1),v(:,2),color3,'FaceAlpha',0.5,'EdgeColor',color3,'LineWidth',2);
                v=[-9.82550 42.8777; -9.82550 43.20291; -9.70053 43.38084; -9.62991 43.35788; -9.75134 43.18289; -9.75134 42.8777];
                m_patch(v(:,1),v(:,2),color4,'FaceAlpha',0.5,'EdgeColor',color4,'LineWidth',2);
                v=[-10.07818 43.52240; -9.72 44.0; -9.13 44.0; -9.62991 43.35788];
                m_patch(v(:,1),v(:,2),color5,'FaceAlpha',0.5,'EdgeColor',color5,'LineWidth',2);
                v=[-10.2292 42.0; -10.2292 42.8777; -9.75134 42.8777; -9.75134 42.0];
                m_patch(v(:,1),v(:,2),color6,'FaceAlpha',0.5,'EdgeColor',color6,'LineWidth',2);

                %Eqtiquetas de ciudades y cabo
                m_text(-8.74,42.16,'Vigo','Color',[100 121 162]./256,'FontSize',10,'FontAngle','Italic','FontWeight','Bold');
                m_text(-8.62,41.17,'Porto','Color',[100 121 162]./256,'FontSize',10,'FontAngle','Italic','FontWeight','Bold');     
                m_text(-8.41,43.30,'A Coruña','Color',[100 121 162]./256,'FontSize',10,'FontAngle','Italic','FontWeight','Bold');
                m_text(-9.55,42.94,'Fisterra','Color',[217 95 2]./256,'FontSize',10,'FontAngle','Italic','FontWeight','Bold');

                %Flechas de carriles
                m_vec(1,-10.1976,43.03,0,-0.2,'FaceColor',[1 0 0],'EdgeColor',[1 0 0],'FaceAlpha',1,'LineWidth',1);
                m_vec(1,-10.1043,43.03,0,-0.2,'FaceColor',[0 0 0],'EdgeColor',[0 0 0],'FaceAlpha',1,'LineWidth',1);
                m_vec(1,-9.9491,42.9,0,0.2,'FaceColor',[1 0 0],'EdgeColor',[1 0 0],'FaceAlpha',1,'LineWidth',1);
                m_vec(1,-9.7925,42.9,0,0.2,'FaceColor',[0 0 0],'EdgeColor',[0 0 0],'FaceAlpha',1,'LineWidth',1);



                %Marcas divisorias
                x0=-8.69; y0=41.13;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);
                x0=-8.88; y0=41.85;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);
                x0=-9.05; y0=42.51;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);
                x0=-9.29; y0=42.88;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);
                x0=-8.84; y0=43.35;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);
                x0=-8.34; y0=43.55;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);
                x0=-7.89; y0=43.78;
                x=[x0 x0-0.05 x0-0.05 x0]; y=[y0 y0-0.025 y0+0.025 y0];
                m_patch(x,y,[217 95 2]./256);



                %Porcentajes de llegada en áreas de salida
                desfasex=-0.1; %Esto es para que centre el texto

                isee12=find(data(:,1)==1 | data(:,1)==2);
                m_text(-10.1976+desfasex,43.27,strcat(num2str(length(isee12)/(365*Nreps)*100 , '%.2f'),'%'),'FontWeight','Bold','FontSize',10);
                isee34=find(data(:,1)==1 | data(:,1)==2);
                m_text(-10.1043+desfasex,43.20,strcat(num2str(length(isee34)/(350*Nreps)*100 , '%.2f'),'%'),'FontWeight','Bold','FontSize',10);  
                isee56=find(data(:,1)==5 | data(:,1)==6);
                m_text(-9.9491+desfasex,43.13,strcat(num2str(length(isee56)/(325*Nreps)*100 , '%.2f'),'%'),'FontWeight','Bold','FontSize',10);
                isee78=find(data(:,1)==7 | data(:,1)==8);
                m_text(-9.7925+desfasex,43.04,strcat(num2str(length(isee78)/(305*Nreps)*100 , '%.2f'),'%'),'FontWeight','Bold','FontSize',10);        
                isee9=find(data(:,1)==9);
                m_text(-9.6+desfasex,43.75,strcat(num2str(length(isee9)/(500*Nreps)*100 , '%.2f'),'%'),'FontWeight','Bold','FontSize',10);    
                isee10=find(data(:,1)==10);
                m_text(-10+desfasex,42.5,strcat(num2str(length(isee10)/(500*Nreps)*100 , '%.2f'),'%'),'FontWeight','Bold','FontSize',10);


                % CIRCULOS

                t = linspace(0,2*pi,200);
                factorx=0.7;
                factorcircle=0.35;
		totalparticulas=[365 350 325 305 500 500].*Nreps;
		color=[color1;color2;color3;color4;color5;color6];

                %Zona Valdoviño 
                x0= -8.14; y0=43.65; 

                isee12=find( (data(:,1)==1 | data(:,1)==2) & data(:,5)>-8.34 & data(:,6)>=43.55 & data(:,6)<43.78);   
                isee34=find( (data(:,1)==3 | data(:,1)==4) & data(:,5)>-8.34 & data(:,6)>=43.55 & data(:,6)<43.78); 
                isee56=find( (data(:,1)==5 | data(:,1)==6) & data(:,5)>-8.34 & data(:,6)>=43.55 & data(:,6)<43.78);  
                isee78=find( (data(:,1)==7 | data(:,1)==8) & data(:,5)>-8.34 & data(:,6)>=43.55 & data(:,6)<43.78);  
		isee9 =find( data(:,1)==9 & data(:,5)>-8.34 & data(:,6)>=43.55 & data(:,6)<43.78);
		isee10=find( data(:,1)==10 & data(:,5)>-8.34 & data(:,6)>=43.55 & data(:,6)<43.78);

                isee=[length(isee12) length(isee34) length(isee56) length(isee78) length(isee9) length(isee10)]./totalparticulas*100;
                
                [value,index]=sort(isee,'descend');
                for count=1:length(index)
                    posicionador=index(count);
                    a=sqrt(isee(posicionador)/pi)*factorcircle;
                    a=round(a*100)/100; %Truquito para que se diferencien algo más los valores...                        
                    b=a*factorx;
                    x = x0 + a*cos(t);
                    y = y0 + b*sin(t);
                    m_patch(x,y,squeeze(color(posicionador,:)),'FaceAlpha',1,'EdgeColor',squeeze(color(posicionador,:)),'LineWidth',0.1);
                end

                %Zona Coruña
                x0= -8.57; y0=43.31; 

                isee12=find( (data(:,1)==1 | data(:,1)==2) & data(:,5)>-8.84 & data(:,6)<43.55);   
                isee34=find( (data(:,1)==3 | data(:,1)==4) & data(:,5)>-8.84 & data(:,6)<43.55); 
                isee56=find( (data(:,1)==5 | data(:,1)==6) & data(:,5)>-8.84 & data(:,6)<43.55);  
                isee78=find( (data(:,1)==7 | data(:,1)==8) & data(:,5)>-8.84 & data(:,6)<43.55);  
		isee9 =find( data(:,1)==9 & data(:,5)>-8.84 & data(:,6)<43.55);
		isee10=find( data(:,1)==10 & data(:,5)>-8.84 & data(:,6)<43.55);

                isee=[length(isee12) length(isee34) length(isee56) length(isee78) length(isee9) length(isee10)]./totalparticulas*100;
                
                [value,index]=sort(isee,'descend');
                for count=1:length(index)
                    posicionador=index(count);
                    a=sqrt(isee(posicionador)/pi)*factorcircle;
                    a=round(a*100)/100; %Truquito para que se diferencien algo más los valores...                        
                    b=a*factorx;
                    x = x0 + a*cos(t);
                    y = y0 + b*sin(t);
                    m_patch(x,y,squeeze(color(posicionador,:)),'FaceAlpha',1,'EdgeColor',squeeze(color(posicionador,:)),'LineWidth',0.1);
                end


                %Costa da Morte
                x0= -9.17; y0=43.17; 

                isee12=find( (data(:,1)==1 | data(:,1)==2) & data(:,5)<-8.84 & data(:,6)<43.35 & data(:,6)>42.88);   
                isee34=find( (data(:,1)==3 | data(:,1)==4) & data(:,5)<-8.84 & data(:,6)<43.35 & data(:,6)>42.88); 
                isee56=find( (data(:,1)==5 | data(:,1)==6) & data(:,5)<-8.84 & data(:,6)<43.35 & data(:,6)>42.88);  
                isee78=find( (data(:,1)==7 | data(:,1)==8) & data(:,5)<-8.84 & data(:,6)<43.35 & data(:,6)>42.88);  
		isee9 =find( data(:,1)==9 & data(:,5)<-8.84 & data(:,6)<43.55 & data(:,6)>42.88);
		isee10=find( data(:,1)==10 & data(:,5)<-8.57 & data(:,6)<43.55 & data(:,6)>42.88);

                isee=[length(isee12) length(isee34) length(isee56) length(isee78) length(isee9) length(isee10)]./totalparticulas*100;
                
                [value,index]=sort(isee,'descend');
                for count=1:length(index)
                    posicionador=index(count);
                    a=sqrt(isee(posicionador)/pi)*factorcircle;
                    a=round(a*100)/100; %Truquito para que se diferencien algo más los valores...   
                    b=a*factorx;
                    x = x0 + a*cos(t);
                    y = y0 + b*sin(t);
                    m_patch(x,y,squeeze(color(posicionador,:)),'FaceAlpha',1,'EdgeColor',squeeze(color(posicionador,:)),'LineWidth',0.1);
                end

                %Muros - Corcubion
                x0= -9.11; y0=42.72; 

                isee12=find( (data(:,1)==1 | data(:,1)==2) & data(:,5)<-9 & data(:,6)<42.88 & data(:,6)>42.51);   
                isee34=find( (data(:,1)==3 | data(:,1)==4) & data(:,5)<-9 & data(:,6)<42.88 & data(:,6)>42.51); 
                isee56=find( (data(:,1)==5 | data(:,1)==6) & data(:,5)<-9 & data(:,6)<42.88 & data(:,6)>42.51);  
                isee78=find( (data(:,1)==7 | data(:,1)==8) & data(:,5)<-9 & data(:,6)<42.88 & data(:,6)>42.51);  
		isee9 =find( data(:,1)==9 & data(:,5)<-9 & data(:,6)<42.88 & data(:,6)>42.51);
		isee10=find( data(:,1)==10 & data(:,5)<-9 & data(:,6)<42.88 & data(:,6)>42.51);

                isee=[length(isee12) length(isee34) length(isee56) length(isee78) length(isee9) length(isee10)]./totalparticulas*100;
                
                [value,index]=sort(isee,'descend');
                for count=1:length(index)
                    posicionador=index(count);
                    a=sqrt(isee(posicionador)/pi)*factorcircle;
                    a=round(a*100)/100; %Truquito para que se diferencien algo más los valores...                        
                    b=a*factorx;
                    x = x0 + a*cos(t);
                    y = y0 + b*sin(t);
                    m_patch(x,y,squeeze(color(posicionador,:)),'FaceAlpha',1,'EdgeColor',squeeze(color(posicionador,:)),'LineWidth',0.1);
                end

                %Rías Baixas
                x0= -8.87; y0=42.24; 

                isee12=find( (data(:,1)==1 | data(:,1)==2) & data(:,5)>-9 & data(:,6)<42.65 & data(:,6)>41.85);   
                isee34=find( (data(:,1)==3 | data(:,1)==4) & data(:,5)>-9 & data(:,6)<42.65 & data(:,6)>41.85); 
                isee56=find( (data(:,1)==5 | data(:,1)==6) & data(:,5)>-9 & data(:,6)<42.65 & data(:,6)>41.85);  
                isee78=find( (data(:,1)==7 | data(:,1)==8) & data(:,5)>-9 & data(:,6)<42.65 & data(:,6)>41.85);  
		isee9 =find( data(:,1)==9 & data(:,5)>-9 & data(:,6)<42.65 & data(:,6)>41.85);
		isee10=find( data(:,1)==10 & data(:,5)>-9 & data(:,6)<42.65 & data(:,6)>41.85);

                isee=[length(isee12) length(isee34) length(isee56) length(isee78) length(isee9) length(isee10)]./totalparticulas*100;
                
                [value,index]=sort(isee,'descend');
                for count=1:length(index)
                    posicionador=index(count);
                    a=sqrt(isee(posicionador)/pi)*factorcircle;
                    a=round(a*100)/100; %Truquito para que se diferencien algo más los valores...                        
                    b=a*factorx;
                    x = x0 + a*cos(t);
                    y = y0 + b*sin(t);
                    m_patch(x,y,squeeze(color(posicionador,:)),'FaceAlpha',1,'EdgeColor',squeeze(color(posicionador,:)),'LineWidth',0.1);
                end


                %Norte Portugal
                x0= -8.8; y0=41.5; 

                isee12=find( (data(:,1)==1 | data(:,1)==2) & data(:,6)<41.85 & data(:,6)>41.13);   
                isee34=find( (data(:,1)==3 | data(:,1)==4) & data(:,6)<41.85 & data(:,6)>41.13); 
                isee56=find( (data(:,1)==5 | data(:,1)==6) & data(:,6)<41.85 & data(:,6)>41.13);  
                isee78=find( (data(:,1)==7 | data(:,1)==8) & data(:,6)<41.85 & data(:,6)>41.13);  
		isee9 =find( data(:,1)==9 & data(:,6)<41.85 & data(:,6)>41.13);
		isee10=find( data(:,1)==10 & data(:,6)<41.85 & data(:,6)>41.13);

                isee=[length(isee12) length(isee34) length(isee56) length(isee78) length(isee9) length(isee10)]./totalparticulas*100;
                
                [value,index]=sort(isee,'descend');
                for count=1:length(index)
                    posicionador=index(count);
                    a=sqrt(isee(posicionador)/pi)*factorcircle;
                    a=round(a*100)/100; %Truquito para que se diferencien algo más los valores...                        
                    b=a*factorx;
                    x = x0 + a*cos(t);
                    y = y0 + b*sin(t);
                    m_patch(x,y,squeeze(color(posicionador,:)),'FaceAlpha',1,'EdgeColor',squeeze(color(posicionador,:)),'LineWidth',0.1);
                end
 
                x0=-9.9; y0=41.35;
                a=sqrt(5/pi)*factorcircle;                      
                b=a*factorx;
                x = x0 + a*cos(t);
                y = y0 + b*sin(t);
                m_patch(x,y,[1 1 1],'FaceAlpha',0,'EdgeColor',[1 1 1],'LineWidth',2);
                
                a=sqrt(2/pi)*factorcircle;                      
                b=a*factorx;
                x = x0 + a*cos(t);
                y = y0 + b*sin(t);
                m_patch(x,y,[1 1 1],'FaceAlpha',0,'EdgeColor',[1 1 1],'LineWidth',2);

                a=sqrt(1/pi)*factorcircle;                      
                b=a*factorx;
                x = x0 + a*cos(t);
                y = y0 + b*sin(t);
                m_patch(x,y,[1 1 1],'FaceAlpha',0,'EdgeColor',[1 1 1],'LineWidth',2);

                m_text(x0+0.2,y0+0.2,'5%','Color','w','FontWeight','Bold','FontSize',10);
                m_text(x0+0.13,y0+0.13,'2%','Color','w','FontWeight','Bold','FontSize',10);
                m_text(x0+0.04,y0+0.04,'1%','Color','w','FontWeight','Bold','FontSize',10);


               set(gca, 'LooseInset', [0,0.03,0,0]);

		%set(gca,'LooseInset',get(gca,'TightInset'));
		%fixedar;
		%print -dtiff -r300 vulnerability_annual_3d.tif
           
               if(mensual)
                 prefix='vulnerability_month';
                 filename=strcat(prefix,num2str(repeticion),'_',num2str(diapred-1),'d.tif');
               else
                 prefix='vulnerability_annual_inner_sindeflect_';
                 filename=strcat(prefix,num2str(diapred-1),'d.tif');
               end
               
               %fixedar;
               %print(fig,'-r300','-dtiff',filename);
               %close(fig);  
                

   end
end

